#! /usr/bin/env bash

# ID: rb868x 1566 Jun 24 13:22 verifyUserAccount.bash.exe
# Tested on Red Hat 5.3, Solaris 10


#######################################
. common.VerifyUserAccount.bash

cat /dev/null > $OUTPUT_OSUITS_ATTUID
cat /dev/null > $OUTPUT_SUITS_ATTUID
cat /dev/null > $OUTPUT_NOMATCH_ATTUID
#######################################


# Only mtstage has FTP access to DB, therefore check that hostname == mtstage
if [[ `hostname` == mtstage ]]; then
   # curl -O "ftp://thprod37.sbc.com/{suits.dat,osuits.dat}"
   ./curlWebphoneDB.bash
fi

# Check OSUITS DB
./findNonATT.bash osuits.dat
if [[ -s $OUTPUT_OSUITS_ATTUID ]]; then
   echo -e "Output written to: $OUTPUT_OSUITS_ATTUID\n"
   echo -e "Remove the following User Accounts:"
   cat $OUTPUT_OSUITS_ATTUID
else echo NONE FOUND OSUITS DB
fi

# Check SUITS DB
./findNonATT.bash suits.dat
if [[ -s $OUTPUT_SUITS_ATTUID ]]; then
   echo -e "Output written to: $OUTPUT_SUITS_ATTUID\n"
   echo -e "Remove the following User Accounts:"
   cat $OUTPUT_SUITS_ATTUID
else echo NONE FOUND SUITS DB
fi

# Check for User Accounts that DO NOT CONFORM to ATTUID
echo -e "\nChecking for User Accounts that are DO NOT CONFORM to ATTUID"
getent passwd | while read f; do
   echo $f | egrep -v "^$ATTUID|nologin" |cut -d':' -f1 >> $OUTPUT_NOMATCH_ATTUID
done

if [[ -s $OUTPUT_NOMATCH_ATTUID ]]; then
   echo -e "Output written to: $OUTPUT_NOMATCH_ATTUID\n"
   perl -pi -e 'print "Verify and Remove the following User Accounts:\n" if $.==1' $OUTPUT_NOMATCH_ATTUID
   cat $OUTPUT_NOMATCH_ATTUID
else echo NONE FOUND
fi
